<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Page - View and Add Data</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* General Styling */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fd;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h2 {
            text-align: center;
            font-weight: 600;
            color: #444;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 15px;
            text-align: center;
            border: 1px solid #ddd;
        }

        th {
            background-color: #f1f5f9;
            font-size: 16px;
            font-weight: 600;
            color: #555;
        }

        #fileInput {
            margin: 20px;
        }

        .column-container {
            margin-top: 30px;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin-right: 10px;
            background-color: #007bff;
            color: white;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 6px 12px rgba(0, 123, 255, 0.2);
        }

        button:hover {
            background-color: #0069d9;
            transform: translateY(-2px);
        }

        td input, td select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            transition: box-shadow 0.3s ease;
        }

        td input:focus {
            box-shadow: 0 0 5px rgba(90, 155, 246, 0.8);
            outline: none;
        }

        #addRowBtn {
            margin-top: 20px;
        }

    </style>
</head>

<body>

    <h2>Upload Excel File and Add New Data</h2>

    <!-- File Upload for Excel -->
    <input type="file" id="fileInput" accept=".xlsx, .xls" />

    <!-- Primary header selection -->
    <div id="primarySelectionContainer" style="margin: 20px;">
        <label for="primaryHeaderSelect">Select Primary Header: </label>
        <select id="primaryHeaderSelect">
            <!-- Options will be added dynamically -->
        </select>
    </div>

    <!-- Table for displaying the data -->
    <table id="userTable">
        <thead>
            <tr id="tableHeaders"></tr>
        </thead>
        <tbody id="tableBody">
            <!-- Data will be loaded here dynamically -->
        </tbody>
    </table>

    <div class="column-container">
        <button id="addRowBtn">Add New Row</button>
        <button id="submitDataBtn">Submit New Data</button>
        <button id="downloadExcelBtn">Download Excel</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        let headers = [];
        let uploadedData = [];
        let newRowsData = [];
        let primaryHeader = null;

        // Handle File Upload
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                // Store headers and data
                headers = jsonData[0];
                uploadedData = jsonData.slice(1);

                // Display in table and enable primary selection
                renderTable();
                populatePrimaryHeaderSelection();
            };

            reader.readAsArrayBuffer(file);
        }

        // Render table with uploaded data
        function renderTable() {
            const tableHeaders = document.getElementById('tableHeaders');
            const tableBody = document.getElementById('tableBody');

            // Clear existing table
            tableHeaders.innerHTML = '';
            tableBody.innerHTML = '';

            // Add headers
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                tableHeaders.appendChild(th);
            });

            // Add rows from uploaded data (non-editable)
            uploadedData.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });

            // Add new rows section (editable)
            newRowsData.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach((header, index) => {
                    const td = document.createElement('td');
                    if (header === primaryHeader) {
                        // Create a dropdown for the primary header
                        const select = document.createElement('select');
                        const uniqueValues = [...new Set(uploadedData.map(d => d[index]))];
                        uniqueValues.forEach(value => {
                            const option = document.createElement('option');
                            option.value = value;
                            option.textContent = value;
                            select.appendChild(option);
                        });
                        td.appendChild(select);
                    } else {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = row[index] || '';
                        td.appendChild(input);
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }

        // Populate primary header selection dropdown
        function populatePrimaryHeaderSelection() {
            const primaryHeaderSelect = document.getElementById('primaryHeaderSelect');
            primaryHeaderSelect.innerHTML = '';
            headers.forEach(header => {
                const option = document.createElement('option');
                option.value = header;
                option.textContent = header;
                primaryHeaderSelect.appendChild(option);
            });

            primaryHeaderSelect.addEventListener('change', function () {
                primaryHeader = this.value;
                renderTable(); // Re-render table when primary header changes
            });
        }

        // Add new rows functionality
        document.getElementById('addRowBtn').addEventListener('click', () => {
            const newRow = Array(headers.length).fill('');
            newRowsData.push(newRow);
            renderTable();
        });

        // Submit new data
        document.getElementById('submitDataBtn').addEventListener('click', submitNewData);

        function submitNewData() {
            const tableBody = document.getElementById('tableBody');
            const newRowElements = Array.from(tableBody.getElementsByTagName('tr')).slice(uploadedData.length);

            // Gather new rows data
            newRowsData = newRowElements.map(tr => {
                return Array.from(tr.getElementsByTagName('td')).map(td => {
                    const input = td.querySelector('input, select');
                    return input ? input.value : '';
                });
            });

            console.log('New Rows Data:', newRowsData);

            alert('New data has been submitted successfully! You can further process or store this data.');
        }

        // Download the data as an Excel file
        document.getElementById('downloadExcelBtn').addEventListener('click', function () {
            const allData = [headers].concat(uploadedData).concat(newRowsData);
            const worksheet = XLSX.utils.aoa_to_sheet(allData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
            XLSX.writeFile(workbook, "UpdatedData.xlsx");
        });

    </script>

</body>

</html>
